.Dd July 29, 2009
.Os
.Dt QUERY_HBF \&1 "Vivic Networks Command Manual"
.Sh NAME
.Nm query_hbf
.Nd query HBFs for input data
.Sh SYNOPSIS
.HP
.Nm
.Op Fl c Ar configuration_file
.Oo
.Op Fl n Ar network
 ...
|
.Op Fl -source-net Ar source_network
 ...
.Op Fl -dest-net Ar destination_network
 ...
.Oc
.Oo
.Op Fl p Ar port_range
 ...
|
.Op Fl -source-port Ar source_port_range
 ...
.Op Fl -dest-port Ar destination_port_range
 ...
.Oc
.Fl s Ar start_time
.Fl e Ar end_time
.Fl i Ar input_directory
.Fl f Ar input_file
.Fl q Ar query_length
.Fl m Ar match_length
.Nm
.Fl h
.Sh DESCRIPTION
The
.Nm
program queries HBF data generated by the
.Xr synapp_hbf 1
utility to determine if any
.Ar match_length
byte string from the first
.Ar query_length
bytes of
.Ar input_file
traversed the network between
.Ar start_time
and
.Ar end_time .
.Pp
If
.Ar configuration_file
is not specified, the default configuration file location is
.Pa /usr/local/etc/query_hbf.conf .
.Pp
The configuration file format is:
.Pp
.D1 Cm option = Ar value
.Pp
with each option/value pair separated by a newline.
.Pp
The HBFs are read from BerkeleyDB files located in
.Ar input_directory ,
which is assumed to have the following structure:
.Bd -ragged -offset indent
.Pa input_directory/%Y/%m/%d/hbf_%H .
.Ed
.Pp
See
.Xr synapp_hbf 1
for information regarding how to generate these files, and
.Xr strftime 3
for time-formatting information. All times are in GMT.
.Pp
When a matching HBF is found, information about the flow is printed to standard output in the following format:
.Bd -ragged -offset indent
.Ar source_ip destination_ip source_port destination_port start_time end_time base64_match_string
.Ed
.Pp
.Ar base64_match_string
is the base64-encoded
.Ar match_length
portion of the input data that matched an HBF. Results are separated by a newline character.
.Pp
The following command-line options are required:
.Bl -tag -width indent -offset indent
.It Fl s Ar start_time
.It Fl -start-time Ar start_time
Specify the beginning of the time interval to query, inclusive.
Must be specified in GMT, with the format "%Y[-%m[-%d[ %H[:%M[:%S]]]]]".
.It Fl e Ar end_time
.It Fl -end-time Ar end_time
Specify the end of the time interval to query, exclusive. Must be specified in GMT,
with the format "%Y[-%m[-%d[ %H[:%M[:%S]]]]]".
.It Fl i Ar input_directory
.It Fl -input-dir Ar input_directory
Specify the directory from which to read HBFs.
.It Fl f Ar input_file
.It Fl -input-file Ar input_file
Specify the file containing the data to be queried for.
.It Fl q Ar query_length
.It Fl -query-length Ar query_length
Specify the number of bytes from the beginning of
.Ar input_file
to use for the query.
.It Fl m Ar match_length
.It Fl -match-length Ar match_length
Specify the minimum length of a substring of the first
.Ar query_length
bytes of
.Ar input_file
necessary in order for a flow to be considered a match.
.El
.Pp
The following command-line options are optional:
.Bl -tag -width indent -offset indent
.It Fl c Ar configuration_file
.It Fl -config-file Ar configuration_file
Specify the file from which to read additional configuration options.
.It Fl h
.It Fl -help
Print a help message to stdout.
.It Fl n Ar network
.It Fl -network Ar network
Specify a CIDR network block that either the source or destination IP address of
a flow must be a part of in order for it to be considered for a match. Cannot be combined with 
either of the
.Fl -source-net
or
.Fl -dest-net
options.
.It Fl -source-net Ar network
Specify a CIDR network block that the soure IP address of
a flow must be a part of in order for it to be considered for a match. Cannot be combined with the
.Fl -network
option.
.It Fl -dest-net Ar network
Specify a CIDR network block that the destination IP address of
a flow must be a part of in order for it to be considered for a match. Cannot be combined with the
.Fl -network
option.
.It Fl p Ar port_range
.It Fl -port Ar port_range
Specify a port number or range that either the source or destination port of a flow
must fall into in order for it to be considered for a match. Cannot be combined with either of the
.Fl -source-port
or
.Fl -dest-port
options.
.It Fl -source-port Ar port_range
Specify a port number or range that the source port of a flow must fall into in order for it to be considered for a match. Cannot be combined with the
.Fl -port
option.
.It Fl -dest-port Ar port_range
Specify a port number or range that the destination port of a flow must fall into in
order for it to be considered for a match. Cannot be combined with the
.Fl -port
option.
.El
.Pp
The following configuration-file options are required:
.Bl -tag -width indent -offset indent
.It Cm max-mtu = Ar number
Specify the maximum MTU of all monitored network segments.
.It Cm max-flows = Ar number
Specify the maximum number of HBFs to keep in memory while querying.
.It Cm thread-count = Ar number
Specify the number of query threads to use for checking HBFs.
.El
.Sh EXIT STATUS
.Nm 
exits 0 on success, and >0 if an error occurs.
.Sh EXAMPLES
Query data in
.Pa /home/user/synapp_data
for a 512-byte match from the first 1024 bytes of
.Pa picture.png ,
in all of 2008:
.Bd -ragged -offset indent
query_hbf -i /home/user/synapp_data -f picture.png -q 1024 -m 512 -s "2008" -e "2009"
.Ed
.Pp
from port 80:
.Bd -ragged -offset indent
query_hbf -i /home/user/synapp_data -f picture.png -q 1024 -m 512 -s "2008" -e "2009" --source-port 80
.Ed
.Pp
from port 80 or from port 8080:
.Bd -ragged -offset indent
query_hbf -i /home/user/synapp_data -f picture.png -q 1024 -m 512 -s "2008" -e "2009" --source-port 80 --source-port 8080
.Ed
.Pp
from port 80 of 10.0.0.20:
.Bd -ragged -offset indent
query_hbf -i /home/user/synapp_data -f picture.png -q 1024 -m 512 -s "2008" -e "2009" --source-port 80 --source-net 10.0.0.20
.Ed
.Pp
from port 80 of any host in 10.0.0.0/24:
.Bd -ragged -offset indent
query_hbf -i /home/user/synapp_data -f picture.png -q 1024 -m 512 -s "2008" -e "2009" --source-port 80 --source-net 10.0.0.0/24
.Ed
.Pp
from port 80 to any host in 10.0.0.0/24 or 10.0.1.0/24:
.Bd -ragged -offset indent
query_hbf -i /home/user/synapp_data -f picture.png -q 1024 -m 512 -s "2008" -e "2009" --source-port 80 --dest-net 10.0.0.0/24 --dest-net 10.0.1.0/24
.Ed
.Pp
from port 80 to any port >= 1024 of any host in 10.0.0.0/24 or 10.0.1.0/24:
.Bd -ragged -offset indent
query_hbf -i /home/user/synapp_data -f picture.png -q 1024 -m 512 -s "2008" -e "2009" --source-port 80 --dest-port 1024- --dest-net 10.0.0.0/24 --dest-net 10.0.1.0/24
.Ed
.Pp
from port 80 to any port between 2000 and 3000 of any host in 10.0.0.0/24 or 10.0.1.0/24:
.Bd -ragged -offset indent
query_hbf -i /home/user/synapp_data -f picture.png -q 1024 -m 512 -s "2008" -e "2009" --source-port 80 --dest-port 2000-3000 --dest-net 10.0.0.0/24 --dest-net 10.0.1.0/24
.Ed
.Sh SEE ALSO
.Xr synapp_hbf 1 ,
.Xr strftime 3
.\" vim: set filetype=groff nu:
